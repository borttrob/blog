(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{482:function(e,t,o){"use strict";o.r(t);var s=o(9),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[o("p",[e._v("An obvious requirement for a payment/checkout system is to accept "),o("strong",[e._v("vouchers")]),e._v(", i.e. codes that can be entered during checkout and lead to a price reduction. Introducing such a system means that you suddenly have "),o("strong",[e._v("two payment services")]),e._v(" where each has to confirm it's part of the payment. E.g. 30€ paid by voucher credit and 20€ paid by credit card. A natural requirement is that the payment process must be transactional, i.e. if the voucher service or credit card service rejects the payment, both payments must be rolled back. Let's explore how you can implement such a system with "),o("a",{attrs:{href:"https://stripe.com",target:"_blank",rel:"noopener noreferrer"}},[e._v("Stripe"),o("OutboundLink")],1),e._v(".")]),e._v(" "),o("p",[o("a",{attrs:{href:"https://stripe.com",target:"_blank",rel:"noopener noreferrer"}},[e._v("Stripe"),o("OutboundLink")],1),e._v(" is one of the most widely used Payment Gateways, but since you came here voluntarily you know this already. In a just world Stripe would provide a native voucher system and therefore the pains of synchronizing voucher and card payment would be hidden from us poor developers. But unfortunately Stripe doesn't have a native voucher system. Therefore we have to implement a synchronisation wrapper on our own.")]),e._v(" "),o("p",[e._v("(Note: Stripe "),o("em",[e._v("has")]),e._v(" "),o("a",{attrs:{href:"https://stripe.com/docs/payments/checkout/discounts",target:"_blank",rel:"noopener noreferrer"}},[e._v("a coupon system"),o("OutboundLink")],1),e._v(" that is only available for "),o("a",{attrs:{href:"https://stripe.com/de/payments/checkout",target:"_blank",rel:"noopener noreferrer"}},[e._v("Stripe Checkout"),o("OutboundLink")],1),e._v(". If you only need discount/promo codes in your application you can stop reading.)")]),e._v(" "),o("h3",{attrs:{id:"options"}},[e._v("Options")]),e._v(" "),o("p",[e._v("There are three alternatives how this synchronisation could look like")]),e._v(" "),o("ol",[o("li",[e._v("Redeem the voucher. If successful, perform stripe payment.")]),e._v(" "),o("li",[e._v("Perform Stripe payment. If successful, redeem the voucher.")]),e._v(" "),o("li",[e._v("Redeem voucher and perform Stripe payment in parallel.")])]),e._v(" "),o("p",[e._v("Let's discuss these possibilities in detail.")]),e._v(" "),o("h4",{attrs:{id:"_1-redeem-the-voucher-if-successful-perform-stripe-payment"}},[e._v("1. Redeem the voucher. If successful, perform stripe payment.")]),e._v(" "),o("p",[e._v("First we have to consider that different payment methods have different ways to give feedback about payment success. E.g card payment, have an almost instantaneous feedback if the payment was successful. There is almost no delay between the time the user clicks the "),o("em",[e._v("Pay")]),e._v(" button and the success callback.")]),e._v(" "),o("p",[e._v("On the other hand some payment methods forward you to the website of the payment provider, e.g. Giropay or Sofort, which are popular in Germany. The user could abandon the process after being forwarded to the website of the payment provider. You won't get any information whatsoever about  the state the user is in. Only if the payment succeeded or there was some technical issue that cancelled the payment.")]),e._v(" "),o("p",[e._v("If you only use payment methods of the first type - Congratulations! You can stop reading and implement this option without any problems.")]),e._v(" "),o("p",[e._v("If, on the other hand, you have to support payment methods of the second type, you might have a problem. Assume you have redeemed the voucher, forwarded the user to e.g. Giropay website, and the user abandoned the payment session. In other words you have invalidated the voucher, but the user didn't buy anything. The voucher won't work if the user tries to buy something in the future, which in turn results in a bad user experience.")]),e._v(" "),o("p",[e._v("What can you do to resolve this?")]),e._v(" "),o("p",[e._v("One possibility is to introduce a "),o("strong",[e._v("session timeout")]),e._v(". If the user doesn't complete the payment within e.g. 30 min, cancel the session and undo the voucher redemption. The obvious drawback is that the user won't be able to use the voucher for 30min.")]),e._v(" "),o("p",[e._v("Another possibility is to allow only a "),o("strong",[e._v("single checkout session per user")]),e._v('. If the user abandons the payment process and starts another checkout session, the previous checkout session gets automatically cancelled. Cancelling the checkout session means the voucher redemption is rolled back. The drawback is that the user won\'t be able to perform multiple checkouts at same time, which may or may not be a problem in your application context. Note: the concept of a "Shopping Cart" is effectively the concept of a single checkout session.')]),e._v(" "),o("h4",{attrs:{id:"_2-perform-stripe-payment-first-if-successful-redeem-the-voucher"}},[e._v("2. Perform Stripe payment first. If successful, redeem the voucher.")]),e._v(" "),o("p",[e._v("Here we let the user pay with his payment provider of choice. When payment succeeds our backend gets notified by a Stripe WebHook call, and we can finally redeem the voucher.")]),e._v(" "),o("p",[e._v("It is possible (but not very likely) that when we get the Stripe success notification, the voucher was already redeemed in another checkout session. Especially if you consider that the user can take as much time as he/she wants when redirected to e.g. Giropay. The user could abandon checkout session No. 1, open another tab, buy something and then return to the first checkout session to finish. In this case the Stripe payment must be rolled back/cancelled.")]),e._v(" "),o("p",[e._v("Unfortunately stripe doesn't refund its transaction fees if you roll back a payment. As of today the fees are around 3% of the sales volume. Depending on your margin and the probability of such roll backs this can be a substantial cut of you margin.")]),e._v(" "),o("p",[e._v('Again, a single checkout solution, like a "shopping cart" would mitigate this drawback. In our case we wanted our checkout process as lightweight as possible to increase conversion. Therefore, we decided against a shopping cart.')]),e._v(" "),o("h4",{attrs:{id:"_3-redeem-voucher-and-perform-stripe-payment-in-parallel"}},[e._v("3. Redeem voucher and perform Stripe payment in parallel.")]),e._v(" "),o("p",[e._v("This option combines the drawbacks of the previous options. Therefore, I won't discuss it further.")]),e._v(" "),o("h2",{attrs:{id:"summary"}},[e._v("Summary")]),e._v(" "),o("p",[e._v("Unfortunately Stripe doesn't have a native voucher system. In this post I presented multiple options to integrate your own voucher system with Stripe. Each option has its own drawbacks, that may or may not be significant to your application.")]),e._v(" "),o("p",[e._v('For option 1 you have to implement either a session timeout or a "shopping cart". In option 2 you have to swallow Stripe transaction fees because of the occasional roll back of the Stripe payment.')]),e._v(" "),o("p",[e._v("All in all until Stripe implements their own voucher system, a silver bullet solution doesn't seem to exist.")]),e._v(" "),o("h3",{attrs:{id:"references"}},[e._v("References")]),e._v(" "),o("p",[o("a",{attrs:{href:"https://stripe.com/docs/payments/checkout/discounts",target:"_blank",rel:"noopener noreferrer"}},[e._v("Stripe coupon system"),o("OutboundLink")],1)]),e._v(" "),o("Disqus")],1)}),[],!1,null,null,null);t.default=r.exports}}]);